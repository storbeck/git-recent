#!/usr/bin/env zsh

# Git-recent: Show and switch between recently used git branches (zsh version)
count="$1"
if [[ -z "$count" ]]; then
    count=10
fi

if ! [[ "$count" =~ '^[0-9]+$' ]] || (( count <= 0 )); then
    echo "Invalid count '$count'. Using default of 10."
    count=10
fi

if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: not inside a git repository." >&2
    exit 1
fi

current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)
branches=()

while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    from_branch=${line%% *}
    [[ -z "$from_branch" || "$from_branch" == HEAD ]] && continue

    if (( ${branches[(Ie)$from_branch]} == 0 )); then
        branches+=("$from_branch")
    fi

    if (( ${#branches} >= count )); then
        break
    fi

done < <(git reflog --no-abbrev 2>/dev/null | \
         grep -i 'checkout: moving from' | \
         awk '{print $6, $8}' | \
         grep -v '^$')

echo "Recently used branches:"
echo "----------------------"

if (( ${#branches} == 0 )); then
    echo "No recent branches found."
    exit 0
fi

i=1
for branch in "${branches[@]}"; do
    if [[ "$branch" == "$current_branch" ]]; then
        printf "%d) %s *\n" "$i" "$branch"
    else
        printf "%d) %s\n" "$i" "$branch"
    fi
    (( i++ ))
done

echo ""
printf "Enter number to switch to that branch (or press Enter to cancel): "
IFS= read -r choice

if [[ -z "$choice" ]]; then
    exit 0
fi

if [[ "$choice" =~ '^[0-9]+$' ]]; then
    choice_index=$(( choice ))
    if (( choice_index >= 1 && choice_index <= ${#branches} )); then
        selected_branch=${branches[choice_index]}
        echo "Switching to branch: $selected_branch"
        git checkout "$selected_branch"
    else
        echo "Invalid selection."
    fi
else
    echo "Invalid input."
fi
